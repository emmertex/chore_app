<!DOCTYPE html>
<html lang="en">
<html>

<head>
    <title>{{ user.username }}'s Dashboard</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'styles.css' %}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>

    {% load extra_filters %}
    <div class="container">

    <div class="bigblock">
        <h1>{{ user.username }}'s Dashboard</h1>
    </div>



    {% if claimed_chores %}
    <div class="block">
        <h3>Claimed Chores Waiting for Approval</h3>
        <table>
            <thead>
                <tr>
                    <th>Chore</th>
                    <th>Points</th>
                    <th>Claimed</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for chore_claim in claimed_chores %}
                <tr>
                    <td>{{ chore_claim.choreName }} <div class="small-text description">
                      {{ chore_claim.comment }}
                    </div></td>
                    <td>{{ chore_claim.points }}</td>
                    <td>{{ chore_claim.user }}</td>
                    <td class="table-min-width">
                        <div class="chore-modal" id="chore-claim-modal-{{ chore_claim.pk }}">
                            <div class="innerBlock" style="float: left;">Action</div>
                        </div>

                            <div class="chore-options" id="chore-claim-options-{{ chore_claim.pk }}" style="display: none;">
                                <div class="block opaque">
                                    <div class="innerBlock green" onclick="window.location.href='{% url 'approve_chore_claim' chore_claim.pk 0 %}'">Approve</div>
                                    <div class="innerBlock" onclick="window.location.href='{% url 'approve_chore_claim' chore_claim.pk 25 %}'">Approve with 75% Points</div>
                                    <div class="innerBlock" onclick="window.location.href='{% url 'approve_chore_claim' chore_claim.pk 50 %}'">Approve with 50% Points</div>
                                    <div class="innerBlock red" onclick="window.location.href='{% url 'reject_chore_claim' chore_claim.pk %}'">Reject</div>
                                    <div class="innerBlock" onclick="dismissModal()" id="chore-claim-modal-{{ chore_claim.pk }}">Cancel</div>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if available_chores %}
    <div class="block">
        <h3>Available Chores</h3>
        <table>
            <thead>
                <tr>
                    <th>Chore</th>
                    <th>Points</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for chore in available_chores %}
                <tr>
                    <td>{{ chore.name }}    
                        <div class="small-text description">
                            {{ chore.comment }}
                          </div>                    
                        <div class="small-text time">
                            {% if chore.availableTime == -24 %}
                            {% elif chore.availableTime < 0 %}
                                Available Before {{ chore.availableTime|abs_filter }}:00
                            {% elif chore.availableTime > 0 %}
                                Available After {{ chore.availableTime }}:00
                            {% endif %}
                        </div>
                    </td>
                    <td>{{ chore.points }} {% if chore.earlyBonus %} ++ {% endif %}</td>
                    <td class="table-min-width">
                        <div class="innerBlock chore-modal" style="display: inline-block;" id="chore-available-modal-{{ chore.pk }}">Action</div>
                        <div class="innerBlock" style="display: inline-block;" onclick="window.location.href='{% url 'toggle_availability' chore.pk %}';">Disable</div>
                        <div class="chore-options" id="chore-available-options-{{ chore.pk }}" style="display: none;">
                            <div class="block opaque">
                                <div class="innerBlock" onclick="window.location.href='{% url 'edit_chore' chore.pk %}'">Edit</div>
                                <div class="innerBlock" onclick="window.location.href='{% url 'toggle_availability' chore.pk %}'">Make Unavailable</div>
                                <div class="innerBlock red" onclick="if(confirm('Are you sure you want to delete this chore?')){ window.location.href='{% url 'delete_chore' chore.pk %}'; }">Delete Chore</div>
                                <div class="innerBlock" onclick="dismissModal()" id="chore-available-modal-{{ chore.pk }}">Cancel</div>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if unavailable_chores %}
    <div class="block">
        <h3> Unavailable Chores</h3>
        <table>
            <thead>
                <tr>
                    <th>Chore</th>
                    <th>Points</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for chore in unavailable_chores %}
                <tr>
                    <td>{{ chore.name }} <div class="small-text description">
                        {{ chore.comment }}
                      </div>
                        <div class="small-text time">
                            {% if chore.availableTime == -24 %}
                            {% elif chore.availableTime < 0 %}
                                Available Before {{ chore.availableTime|abs_filter }}:00
                            {% elif chore.availableTime > 0 %}
                                Available After {{ chore.availableTime }}:00
                            {% endif %}
                        </div>
                    </td>
                    <td>{{ chore.points }} {% if chore.earlyBonus %} ++ {% endif %}</td>
                    <td class="table-min-width">
                        <div class="chore-modal" id="chore-unavailable-modal-{{ chore.pk }}">
                            <div class="innerBlock" style="display: inline-block;">Action</div>
                            <div class="innerBlock" style="display: inline-block;"  onclick="window.location.href='{% url 'toggle_availability' chore.pk %}';">Enable</div>
                            <div style="clear: both;"></div>
                        </div>
                        <div class="chore-options" id="chore-unavailable-options-{{ chore.pk }}" style="display: none;">
                            <div class="block opaque">
                                <div class="innerBlock" onclick="window.location.href='{% url 'edit_chore' chore.pk %}'">Edit</div>
                                <div class="innerBlock" onclick="window.location.href='{% url 'toggle_availability' chore.pk %}'">Make Available</div>
                                <div class="innerBlock red" onclick="if(confirm('Are you sure you want to delete this chore?')){ window.location.href='{% url 'delete_chore' chore.pk %}'; }">Delete Chore</div>
                                <div class="innerBlock" onclick="dismissModal()" id="chore-unavailable-modal-{{ chore.pk }}">Cancel</div>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <div class="block">
        <h3>Actions</h3>
        <div class="innerBlock" onclick="if (confirm('Are you sure you want to perform this action?')) { window.location.href='{% url 'daily_action' %}' }">
            Daily Action<br><span style="font-size: smaller;">Distribute points, and make Daily Chores available</span>
        </div>
        <div class="innerBlock" onclick="window.location.href='{% url 'create_chore' %}'" class="open-chore-modal">
            Create New Chore {# For a modal #}
        </div>
        <div class="innerBlock" onclick="window.location.href='{% url 'settings' %}'" class="open-chore-modal">
            Settings {# For a modal #}
        </div>
    </div>

    <div class="block">
        <h3> Childrens Points </h3>
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Points</th>
                    <th>Money</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for child in children %}
                <tr>
                    <td>{{ child.username }}</td>
                    <td>{{ child.points_balance }}</td>
                    <td>{{ child.pocket_money }}</td>
                    <td>
                        <a href="{% url 'point_adjustment' child.pk %}">Adjust Points</a><br>
                        <a href="{% url 'pocket_money_adjustment' child.pk %}">Adjust Pocket Money</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="bigblock">
        <h3>Point Log</h2>

            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>User</th>
                        <th>Chore</th>
                        <th>Points Change</th>
                        <th>Penalty</th>
                        <th>Reason</th>
                        <th>Approver</th>
                    </tr>
                </thead>
                <tbody>
                    {% for point_log in point_logs %}
                    <tr>
                        <td>{{ point_log.date_recorded }}</td>
                        <td>{{ point_log.user.username }}</td>
                        <td>{{ point_log.chore }}</td>
                        <td>{{ point_log.points_change }}</td>
                        <td>{{ point_log.penalty }} %</td>
                        <td><pre>{{ point_log.reason }}</pre></td>
                        <td>{% if point_log.approver %}{{ point_log.approver.username }}{% else %}-{% endif %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="pagination">
                <span class="step-links">
                    {% if point_logs.has_previous %}
                        <a href="?page=1">&laquo; first</a>
                        <a href="?page={{ point_logs.previous_page_number }}">previous</a>
                    {% endif %}
            
                    <span class="current-page">{{ point_logs.number }}</span>
            
                    {% if point_logs.has_next %}
                        <a href="?page={{ point_logs.next_page_number }}">next</a>
                        <a href="?page={{ point_logs.paginator.num_pages }}">last &raquo;</a>
                    {% endif %}
                </span>
            </div>
    </div>
    </div>

    <script>
        // Chore Claim Modal
        function initializeChoreClaimModals() {
            document.querySelectorAll('[id^="chore-claim-modal-"]').forEach(function(modalTrigger) {
                var pk = modalTrigger.id.split('-').pop();
                var choreClaimOptions = document.getElementById('chore-claim-options-' + pk);

                modalTrigger.addEventListener('click', function(e) {
                    handleModalClick(e, choreClaimOptions);
                });

                document.querySelectorAll('#chore-claim-options-' + pk + ' a').forEach(function(option) {
                    option.addEventListener('click', function(e) {
                        handleOptionClick(e, choreClaimOptions);
                    });
                });
            });
        }

        // Chore Available Modal
        function initializeChoreAvailableModals() {
            document.querySelectorAll('[id^="chore-available-modal-"]').forEach(function(modalTrigger) {
                var pk = modalTrigger.id.split('-').pop();
                var choreAvailableOptions = document.getElementById('chore-available-options-' + pk);

                modalTrigger.addEventListener('click', function(e) {
                    handleModalClick(e, choreAvailableOptions);
                });

                document.querySelectorAll('#chore-available-options-' + pk + ' a').forEach(function(option) {
                    option.addEventListener('click', function(e) {
                        handleOptionClick(e, choreAvailableOptions);
                    });
                });
            });
        }

        // Chore Unavailable Modal
        function initializeChoreUnavailableModals() {
            document.querySelectorAll('[id^="chore-unavailable-modal-"]').forEach(function(modalTrigger) {
                var pk = modalTrigger.id.split('-').pop();
                var choreUnavailableOptions = document.getElementById('chore-unavailable-options-' + pk);

                modalTrigger.addEventListener('click', function(e) {
                    handleModalClick(e, choreUnavailableOptions);
                });

                document.querySelectorAll('#chore-unavailable-options-' + pk + ' a').forEach(function(option) {
                    option.addEventListener('click', function(e) {
                        handleOptionClick(e, choreUnavailableOptions);
                    });
                });
            });
        }

        // All Modals
        function dismissModal() {
        }

        function handleModalClick(e, choreOptions) {
            e.preventDefault();
            choreOptions.style.display = (choreOptions.style.display === 'block') ? 'none' : 'block';
        }

        function handleOptionClick(e, choreOptions) {
            e.preventDefault();
            choreOptions.style.display = 'none';
        }

        // Call the function to initialize modals when the document is ready
        document.addEventListener('DOMContentLoaded', initializeChoreUnavailableModals);
        document.addEventListener('DOMContentLoaded', initializeChoreAvailableModals);
        document.addEventListener('DOMContentLoaded', initializeChoreClaimModals);

    </script>

</body>

</html>